swagger: "2.0"

info:
  title: Storage
  version: 1.8.0

basePath: /
schemes:
  - http

securityDefinitions:
   pinCode:
     type: apiKey
     in: header
     name: Pin

definitions:
        
  StatusReport:
    type: object
    properties:
      lcw_info:
          type: string
      kasse_status:
          $ref: '#/definitions/Status'
      kasse_info:
          type: string
      stations:
          type: array
          items:
            $ref: '#/definitions/StationStatus'

  StationStatus:
    type: object
    properties:
      id:
          type: integer
      name:
          type: string
      hash:
          $ref: '#/definitions/Hash'
      status:
          $ref: '#/definitions/Status'
      info:
          type: string

  Status:
    type: string
    enum: ["offline", "online"]

  StatusCollectionReport:
    type: object
    properties:
      stations:
          type: array
          items:
            $ref: '#/definitions/CollectionReport'

  CollectionReport:
    type: object
    properties:
      id:
        type: integer
      carsTotal:
        type: integer
      coins:
        type: integer
      banknotes:
        type: integer
      electronical:
        type: integer
      service:
        type: integer
      ctime:
        type: integer
    
  MoneyReport:
    type: object
    required:
        - hash
    properties:
        carsTotal:
          type: integer
        coins:
          type: integer
        banknotes:
          type: integer
        electronical:
          type: integer
        service:
          type: integer
        hash:
          $ref: '#/definitions/Hash'

  RelayReport:
    type: object
    required:
      - hash
    properties:
        hash:
          $ref: '#/definitions/Hash'
        relayStats:
          type: array
          items:
            $ref: '#/definitions/RelayStat'

  StationReport:
    type: object
    properties:
        moneyReport:
          $ref: '#/definitions/MoneyReport'
        relayStats:
          type: array
          items:
            $ref: '#/definitions/RelayStat'

  RelayStat:
    type: object
    properties:
      relayID:
          type: integer
          minimum: 1
          maximum: 6
      switchedCount:
          type: integer
      totalTimeOn:
          type: integer

  Hash:
    type: string
    minLength: 1

  KeyPair:
    type: object
    required:
        - key
        - value
    properties:
        key:    
          type: string
          minLength: 1
        value:
          type: string

  StationsVariables:
    type: object
    properties:
      id:
        type: integer
      name:
        type: string
      hash:
        type: string
        x-nullable: true
      keyPairs:
        type: array
        items:
          $ref: '#/definitions/KeyPair'
  
  ProgramInfo:
    type: object
    properties:
      id:
        type: integer
        minimum: 1
      name:
        type: string
        minLength: 1

  RelayConfig:
    type: object
    properties:
      id:
        type: integer
        minimum: 1
      timeon:
        type: integer
      timeoff:
        type: integer
      prfelight:
        type: integer
  
  KasseConfig:
    type: object
    properties:
      tax:
        type: string
        enum:
          - TAX_VAT110
          - TAX_VAT0 
          - TAX_NO
          - TAX_VAT120
      receiptItemName:
        type: string
        minLength: 1
      cashier:
        type: string
        minLength: 1
      cashierINN:
        type: string
        minLength: 12
        maxLength: 12
        pattern: '^[0123456789]{12}$'

  UserConfig:
    type: object
    required:
        - login
        - firstName
        - middleName
        - lastName
        - isAdmin
        - isOperator
        - isEngineer
        - password
    properties:
      login:
        type: string
        minLength: 1
      firstName:
        type: string
        minLength: 1
      middleName:
        type: string
        minLength: 1
      lastName:
        type: string
        minLength: 1
      isAdmin:
        type: boolean
      isOperator:
        type: boolean
      isEngineer:
        type: boolean
      password:
        type: string
        minLength: 4
        maxLength: 4
        pattern: '^[0123456789]{4}$'

  UsersReport:
    type: object
    properties:
      users:
          type: array
          items:
            $ref: '#/definitions/UserConfig'

consumes:
  - application/json
produces:
  - application/json          

paths:
  /station-report-dates:
    post:
      operationId: "stationReportDates"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - id
              - startDate
              - endDate
            properties:
              id:
                type: integer
              startDate:
                description: Unix time
                type: integer
              endDate:
                description: Unix time
                type: integer
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/StationReport'
        404:
          description: not found
        500:
          description: internal error
  /station-report-current-money:
    post:
      operationId: "stationReportCurrentMoney"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - id
            properties:
              id:
                type: integer
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/StationReport'
        404:
          description: not found
        500:
          description: internal error

  /status:
    get:
      operationId: "status"
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/StatusReport'
        500:
          description: internal error

  /status-collection:
    get:
      operationId: "statusCollection"
      security:
        - pinCode: []
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/StatusCollectionReport'
        500:
          description: internal error
        401:
          description: PIN is missing or invalid

  /add-service-amount:
    post:
      operationId: "addServiceAmount"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            properties:
              hash:
                type: string
              amount:
                type: integer
      responses:
        204:
          description: OK
        404:
          description: not found
        500:
          description: internal error

  /set-station:
    post:
      operationId: "setStation"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - id
            properties:
              id:
                type: integer
              name:
                type: string
              hash:
                type: string
      responses:
        204:
          description: OK
        401:
          description: Access denied. It will happen when you try to change the ID at the station online.
        404:
          description: not found
        422:
          description: validation error
        500:
          description: internal error

  /del-station:
    post:
      operationId: "delStation"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - id
            properties:
              id:
                type: integer
      responses:
        204:
          description: OK
        404:
          description: not found
        500:
          description: internal error
            
  /save-relay:
    post:
      operationId: "saveRelay"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            $ref: '#/definitions/RelayReport'
      responses:
        204:
          description: OK
        404:
          description: not found
        500:
          description: internal error
          
  /load-relay:
    post:
      operationId: "loadRelay"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - hash
            properties:
              hash:
                $ref: '#/definitions/Hash'
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/RelayReport'
        404:
          description: not found
        500:
          description: internal error

  /save-money:
    post:
      operationId: "saveMoney"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            $ref: '#/definitions/MoneyReport'
      responses:
        204:
          description: OK
        404:
          description: not found
        500:
          description: internal error

  /save-collection:
    post:
      operationId: "saveCollection"
      security:
        - pinCode: []
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - id
            properties:
              id:
                type: integer
      responses:
        204: 
          description: OK
        404:
          description: not found
        500:
          description: internal error
        401:
          description: PIN is missing or invalid

  /load-money:
    post:
      operationId: "loadMoney"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - hash
            properties:
              hash:
                $ref: '#/definitions/Hash'
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/MoneyReport'
        404:
          description: not found
        500:
          description: internal error

  /save:
    post:
      operationId: "save"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - hash
              - keyPair
            properties:
              hash:
                $ref: '#/definitions/Hash'
              keyPair:
                $ref: '#/definitions/KeyPair'
      responses:
        204:
          description: OK
        404:
          description: not found
        500:
          description: internal error
  /load:
    post:
      operationId: "load"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - hash
              - key
            properties:
              hash:
                $ref: '#/definitions/Hash'
              key:
                type: string
                minLength: 1
      responses:
        200:
          description: OK
          schema:
            type: string
        404:
          description: not found
        500:
          description: internal error
  /ping:
    post:
      operationId: "ping"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - hash
            properties:
              hash:
                $ref: '#/definitions/Hash'
      responses:
        200:
          description: OK
          schema:
            type: object
            required:
              - serviceAmount
              - openStation
            properties:
              serviceAmount:
                type: integer
              openStation:
                type: boolean
    get:
      operationId: "getPing"
      responses:
        200:
          description: OK
  /info:
    get:
      operationId: "info"
      responses:
        200:
          description: OK
          schema:
            type: string
  /station-by-hash:
    post:
      operationId: "stationByHash"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - hash
            properties:
              hash:
                $ref: '#/definitions/Hash'
      responses:
        200:
          description: OK
          schema:
            type: integer
        500:
          description: internal error
  /save-if-not-exists:
    post:
      operationId: "saveIfNotExists"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - hash
              - keyPair
            properties:
              hash:
                $ref: '#/definitions/Hash'
              keyPair:
                $ref: '#/definitions/KeyPair'
      responses:
        204:
          description: OK
        404:
          description: not found
        500:
          description: internal error
  /stations-variables:
    post:
      operationId: "stationsVariables"
      responses:
        200:
          description: OK
          schema:
            type: array
            items:
              $ref: '#/definitions/StationsVariables'
        500:
          description: internal error
  /open-station:
    post:
      operationId: "openStation"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - stationID
            properties:
              stationID:
                type: integer
      responses:
        204:
          description: OK
        404:
          description: not found
        500:
          description: internal error
  
  /programs:
    post:
      operationId: "programs"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              -  stationID
            properties:
              stationID:
                type: integer
                minimum: 1
      responses:
        200:
          description: OK
          schema:
            type: array
            items:
              $ref: '#/definitions/ProgramInfo'
        500:
          description: internal error
  
  /set-program-name:
    post:
      operationId: "setProgramName"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - programID
              - name
              - stationID
            properties:
              stationID:
                type: integer
                minimum: 1
              programID:
                type: integer
                minimum: 1
              name:
                type: string
                minLength: 1
      responses:
        204:
          description: OK
        500:
          description: internal error
  
  /program-relays:
    post:
      operationId: "programRelays"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - programID
              - stationID
            properties:
              stationID:
                type: integer
                minimum: 1
              programID:
                type: integer
                minimum: 1
      responses:
        200:
          description: OK
          schema:
            type: object
            properties:
              relays:
                type: array
                items:
                  $ref: '#/definitions/RelayConfig'
        500:
          description: internal error
          
  /set-program-relays:
    post:
      operationId: "setProgramRelays"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              -  programID
              -  program
              - stationID
            properties:
              stationID:
                type: integer
                minimum: 1
              programID:
                type: integer
                minimum: 1
              relays:
                type: array
                items:
                  $ref: '#/definitions/RelayConfig'
      responses:
        204:
          description: OK
        500:
          description: internal error
  
  /kasse:
    post:
      operationId: "kasse"
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/KasseConfig'
        404:
          description: not found
        500:
          description: internal error
  /set-kasse:
    post:
      operationId: "setKasse"
      parameters:
        - name: args
          required: true
          in: body
          schema:
            $ref: '#/definitions/KasseConfig'
      responses:
        204:
          description: OK
        500:
          description: internal error

  /users:
    get:
      operationId: "getUsers"
      security:
        - pinCode: []
      responses:
        200:
          description: OK
          schema:
            type: object
            $ref: '#/definitions/UsersReport'
        401:
          description: "PIN is missing or invalid"
        500:
          description: internal error

  /user-password:
    post:
      operationId: "updateUserPassword"
      security:
        - pinCode: []
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - login
              - oldPassword
              - newPassword
            properties:
              login:
                type: string
                minLength: 1
              oldPassword:
                type: string
                minLength: 4
                maxLength: 4
                pattern: '^[0123456789]{4}$'
              newPassword:
                type: string
                minLength: 4
                maxLength: 4
                pattern: '^[0123456789]{4}$'
      responses:
        200:
          description: OK
          schema:
            type: object
            required:
              - id
            properties:
              id:
                type: integer
        401:
          description: "PIN is missing or invalid"
        404:
          description: not found
        500:
          description: internal error

  /user:
    get:
      operationId: "getUser"
      security:
        - pinCode: []
      responses:
        204:
          description: OK
        401:
          description: "PIN is missing or invalid"
    post:
      operationId: "createUser"
      security:
        - pinCode: []
      parameters:
        - name: args
          required: true
          in: body
          schema:
            $ref: '#/definitions/UserConfig'
      responses:
        200:
          description: OK
          schema:
            type: object
            required:
              - id
            properties:
              id:
                type: integer
        400:
          description: Bad argument
        401:
          description: PIN is missing or invalid
        500:
          description: internal error
    put:
      operationId: "updateUser"
      security:
        - pinCode: []
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - login
            properties:
              login:
                type: string
                minLength: 1
              firstName:
                type: string
                x-nullable: true
                minLength: 1
              middleName:
                type: string
                x-nullable: true
                minLength: 1
              lastName:
                type: string
                x-nullable: true
                minLength: 1
              isAdmin:
                type: boolean
                x-nullable: true
              isOperator:
                type: boolean
                x-nullable: true
              isEngineer:
                type: boolean
                x-nullable: true
      responses:
        200:
          description: OK
          schema:
            type: object
            required:
              - id
            properties:
              id:
                type: integer
        400:
          description: Bad argument
        401:
          description: PIN is missing or invalid
        500:
          description: internal error
    delete:
      operationId: "deleteUser"
      security:
        - pinCode: []
      parameters:
        - name: args
          required: true
          in: body
          schema:
            type: object
            required:
              - login
            properties:
              login:
                type: string
      responses:
        204:
          description: OK
        400:
          description: Bad argument
        401:
          description: PIN is missing or invalid
        500:
          description: internal error
